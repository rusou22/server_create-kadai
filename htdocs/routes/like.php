<?php

// =======================================
// 型の厳格化（暗黙の型変換を防ぐ）
// セキュリティ・DB周りでの事故を減らす
// =======================================
declare(strict_types=1);

// =======================================
// 必要ファイル読み込み
// =======================================
require_once __DIR__ . '/../config/db.php';    // DB接続（db()）
require_once __DIR__ . '/../config/auth.php';  // ログイン確認（require_login）
require_once __DIR__ . '/../config/csrf.php';  // CSRF検証（csrf_verify）

// =======================================
// ログイン必須：未ログインなら login.php へ飛ばす
// =======================================
require_login();

// =======================================
// CSRF対策：フォームから送られた csrf_token が正しいか検証
// 不正な外部サイトから勝手に「いいね」を押されるのを防ぐ
// =======================================
csrf_verify();

// =======================================
// DB接続
// =======================================
$pdo = db();

// =======================================
// route_id（いいね対象の投稿ID）をPOSTから取得
// 数値以外は弾く
// =======================================
$routeId = filter_input(INPUT_POST, 'route_id', FILTER_VALIDATE_INT);
if (!$routeId) {
    http_response_code(400);
    exit('不正なIDです');
}

// =======================================
// ログインユーザーID（誰がいいねしたか）
// auth.php のセッションに user_id が入っている前提
// =======================================
$userId = (int)$_SESSION['user_id'];

try {
    // =======================================
    // トランザクション開始
    // いいねの「確認 → 追加/削除」を一連の処理としてまとめる
    // （途中で失敗したらロールバックできる）
    // =======================================
    $pdo->beginTransaction();

    // =======================================
    // すでに「いいね」済みか確認
    // route_id + user_id の組み合わせで検索
    // =======================================
    $chk = $pdo->prepare('SELECT id FROM route_likes WHERE route_id = :rid AND user_id = :uid');
    $chk->execute([':rid' => $routeId, ':uid' => $userId]);

    // fetchColumn() は先頭カラム（ここでは id）を返す
    // 取得できたら「いいね済み」
    $liked = (bool)$chk->fetchColumn();

    if ($liked) {
        // =======================================
        // すでにいいね済み → 解除（削除）
        // =======================================
        $del = $pdo->prepare('DELETE FROM route_likes WHERE route_id = :rid AND user_id = :uid');
        $del->execute([':rid' => $routeId, ':uid' => $userId]);
    } else {
        // =======================================
        // まだいいねしていない → 追加（INSERT）
        // unique制約がある前提で二重登録を防ぐ
        // =======================================
        $ins = $pdo->prepare('INSERT INTO route_likes (route_id, user_id) VALUES (:rid, :uid)');
        $ins->execute([':rid' => $routeId, ':uid' => $userId]);
    }

    // =======================================
    // ここまで成功したら確定（コミット）
    // =======================================
    $pdo->commit();

    // =======================================
    // 元のページへ戻す
    // HTTP_REFERER がある場合はそこへ戻す
    // 無い場合は show.php にフォールバック
    // =======================================
    $back = $_SERVER['HTTP_REFERER'] ?? ('/routes/show.php?id=' . $routeId);
    header('Location: ' . $back);
    exit;

} catch (Throwable $e) {
    // =======================================
    // 例外発生時
    // トランザクション中ならロールバックして元に戻す
    // =======================================
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }

    // エラー応答（ここでは 400）
    http_response_code(400);

    // 画面には詳細を出さず、一般的な失敗メッセージにする
    // （DB情報などが漏れるのを防ぐ意図もある）
    exit('いいね処理に失敗しました');
}
