<?php
declare(strict_types=1);

require_once __DIR__ . '/config/db.php';
require_once __DIR__ . '/config/helpers.php';

$pdo = db();


$counts = array_fill(1, 49, 0);
$stmt = $pdo->query("
  SELECT prefecture_code, COUNT(*) AS cnt
  FROM route_prefectures
  WHERE is_main = 1
  GROUP BY prefecture_code
");
foreach ($stmt->fetchAll() as $row) {
  $code = (int)$row['prefecture_code'];
  if ($code >= 1 && $code <= 49) {
    $counts[$code] = (int)$row['cnt'];
  }
}


function heat_color(int $cnt): string {
  if ($cnt <= 0) return 'rgba(0,0,0,0)';
  if ($cnt <= 10) return 'rgba(82, 190, 0, 0.30)';
  if ($cnt <= 20) return 'rgba(237, 233, 0, 0.30)';
  return 'rgba(240, 23, 23, 0.30)';
}


$areas = [
  // code, name, coords (x1,y1,...), points (x,y x,y ...)
  [47,'沖縄県','76,774,98,774,99,818,76,817','76,774 98,774 99,818 76,817'],
  [46,'鹿児島県','111,720,111,762,136,763,136,749,161,750,161,773,167,774,196,754,196,731,168,731,168,720','111,720 111,762 136,763 136,749 161,750 161,773 167,774 196,754 196,731 168,731 168,720'],
  [43,'熊本県','123,662,123,704,111,713,111,720,167,719,168,662','123,662 123,704 111,713 111,720 167,719 168,662'],
  [45,'宮崎県','169,672,169,731,197,731,196,690,202,682,202,672','169,672 169,731 197,731 196,690 202,682 202,672'],
  [42,'長崎県','78,605,78,668,104,668,103,606','78,605 78,668 104,668 103,606'],
  [41,'佐賀県','103,606,104,651,132,650,132,606','103,606 104,651 132,650 132,606'],
  [40,'福岡県','123,661,168,661,168,624,202,625,202,606,133,606,132,650,123,650','123,661 168,661 168,624 202,625 202,606 133,606 132,650 123,650'],
  [44,'大分県','168,624,169,672,202,672,202,625','168,624 169,672 202,672 202,625'],

  [39,'高知県','229,699,314,700,376,712,376,733,342,733,332,719,299,719,286,733,229,733','229,699 314,700 376,712 376,733 342,733 332,719 299,719 286,733 229,733'],
  [38,'愛媛県','229,669,229,700,314,699,314,665,283,664,283,649','229,669 229,700 314,699 314,665 283,664 283,649'],
  [36,'徳島県','314,672,314,699,376,712,376,672','314,672 314,699 376,712 376,672'],
  [37,'香川県','314,649,314,671,376,672,377,649','314,649 314,671 376,672 377,649'],

  [35,'山口県','250,550,209,578,208,626,250,627','250,550 209,578 208,626 250,627'],
  [32,'島根県','251,585,251,550,301,550,301,584','251,585 251,550 301,550 301,584'],
  [34,'広島県','251,584,251,626,301,626,301,584','251,584 251,626 301,626 301,584'],
  [31,'鳥取県','301,550,302,584,348,584,348,550','301,550 302,584 348,584 348,550'],
  [33,'岡山県','301,584,302,626,348,626,348,584','301,584 302,626 348,626 348,584'],

  [28,'兵庫県','348,550,349,626,397,627,396,550','348,550 349,626 397,627 396,550'],
  [27,'大阪府','397,627,397,612,437,612,437,656,410,656,410,627','397,627 397,612 437,612 437,656 410,656 410,627'],
  [26,'京都府','397,550,397,612,468,612,468,567,428,566,428,550','397,550 397,612 468,612 468,567 428,566 428,550'],
  [29,'奈良県','438,612,438,675,468,675,469,612','438,612 438,675 468,675 469,612'],
  [30,'和歌山県','409,656,409,699,468,699,468,675,438,675,437,656','409,656 409,699 468,699 468,675 438,675 437,656'],
  [24,'三重県','468,612,469,699,497,699,496,632,506,632,505,612','468,612 469,699 497,699 496,632 506,632 505,612'],
  [25,'滋賀県','469,567,469,612,505,612,505,567','469,567 469,612 505,612 505,567'],

  [18,'福井県','429,555,429,566,513,567,513,532,455,532,455,555','429,555 429,566 513,567 513,532 455,532 455,555'],
  [17,'石川県','513,474,485,474,485,512,455,531,513,532','513,474 485,474 485,512 455,531 513,532'],
  [16,'富山県','514,497,534,497,572,468,572,522,514,522','514,497 534,497 572,468 572,522 514,522'],
  [21,'岐阜県','514,523,514,567,505,567,506,612,554,612,553,523','514,523 514,567 505,567 506,612 554,612 553,523'],
  [23,'愛知県','506,612,506,632,517,632,518,653,568,653,568,612','506,612 506,632 517,632 518,653 568,653 568,612'],
  [20,'長野県','554,522,554,612,602,612,602,563,612,563,612,488,572,488,572,522','554,522 554,612 602,612 602,563 612,563 612,488 572,488 572,522'],
  [15,'新潟県','647,418,638,418,572,468,572,488,648,488','647,418 638,418 572,468 572,488 648,488'],

  [10,'群馬県','613,488,613,538,659,537,659,488','613,488 613,538 659,537 659,488'],
  [19,'山梨県','602,563,637,563,637,612,603,612','602,563 637,563 637,612 603,612'],
  [22,'静岡県','568,612,568,653,599,653,630,633,630,654,651,654,651,627,637,626,637,612','568,612 568,653 599,653 630,633 630,654 651,654 651,627 637,626 637,612'],
  [11,'埼玉県','612,538,613,563,703,563,703,537','612,538 613,563 703,563 703,537'],
  [13,'東京都','637,563,637,591,702,590,702,563','637,563 637,591 702,590 702,563'],
  [14,'神奈川県','637,591,637,626,693,627,693,591','637,591 637,626 693,627 693,591'],
  [9,'栃木県','659,488,659,537,703,537,702,489','659,488 659,537 703,537 702,489'],
  [12,'千葉県','703,550,703,590,716,590,717,625,754,625,753,549','703,550 703,590 716,590 717,625 754,625 753,549'],
  [8,'茨城県','702,488,703,549,753,549,744,541,744,489','702,488 703,549 753,549 744,541 744,489'],

  [7,'福島県','647,443,649,488,744,488,744,442','647,443 649,488 744,488 744,442'],
  [6,'山形県','638,380,637,417,647,417,648,442,692,442,693,379','638,380 637,417 647,417 648,442 692,442 693,379'],
  [4,'宮城県','693,380,692,442,744,441,744,380','693,380 692,442 744,441 744,380'],
  [5,'秋田県','637,322,638,380,693,380,693,323','637,322 638,380 693,380 693,323'],
  [3,'岩手県','694,323,693,379,744,379,756,369,756,323','694,323 693,379 744,379 756,369 756,323'],
  [2,'青森県','638,276,638,322,756,322,755,309,726,288,725,257,701,257,700,288,669,288,669,275','638,276 638,322 756,322 755,309 726,288 725,257 701,257 700,288 669,288 669,275'],
  [1,'北海道','672,80,672,187,638,213,638,246,689,246,689,228,712,227,753,256,802,228,845,228,846,158,812,158,716,80','672,80 672,187 638,213 638,246 689,246 689,228 712,227 753,256 802,228 845,228 846,158 812,158 716,80'],

  [48,'淡路島','384,633,384,648,399,648,398,633','384,633 384,648 399,648 398,633'],
  [49,'佐渡島','582,425,568,425,550,439,563,439','582,425 568,425 550,439 563,439'],
];

?>
<style>
  /* 既存レイアウトを崩さないため、地図部分だけに閉じたCSS */
  .dm-map-wrap {
    position: relative;
    display: inline-block;
    max-width: 100%;
  }

  .dm-map-togglebar {
    position: absolute;
    left: 10px;
    top: 10px;
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: rgba(255,255,255,0.92);
    border: 1px solid #e6e6e6;
    border-radius: 999px;
    font-size: 12px;
    user-select: none;
  }

  .dm-map-togglebar button {
    appearance: none;
    border: 1px solid #d0d0d0;
    background: #fff;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    cursor: pointer;
  }
  .dm-map-togglebar button[aria-pressed="true"] {
    border-color: #0b57d0;
    box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
  }

  .dm-map-legend {
    position: absolute;
    left: 10px;
    top: 52px;
    z-index: 5;
    display: none; /* OFFの時は非表示 */
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    padding: 8px 10px;
    background: rgba(255,255,255,0.92);
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    font-size: 12px;
  }
  .dm-map-legend .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border: 1px solid #e6e6e6;
    border-radius: 999px;
    background: #fff;
  }
  .dm-map-legend .dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    border: 1px solid rgba(0,0,0,0.12);
    display: inline-block;
  }

  .dm-heat-overlay {
    position: absolute;
    left: 0;
    top: 0;
    z-index: 4;
    width: 100%;
    height: 100%;
    display: none;         /* OFFの時は非表示 */
    pointer-events: none;  
  }

  .dm-map-wrap.heat-on .dm-heat-overlay { display: block; }
  .dm-map-wrap.heat-on .dm-map-legend { display: flex; }
</style>

<div class="dm-map-wrap" id="dmMapWrap">

  <div class="dm-map-togglebar">
    <span>カラー</span>
    <button type="button" id="dmHeatBtn" aria-pressed="false">OFF</button>
  </div>


  <div class="dm-map-legend" aria-label="凡例">
    <span class="chip"><span class="dot" style="background: rgba(82, 190, 0, 0.76)"></span>1〜10件</span>
    <span class="chip"><span class="dot" style="background: rgba(237, 233, 0, 0.89)"></span>11〜20件</span>
    <span class="chip"><span class="dot" style="background: rgba(240, 23, 23, 0.88)"></span>21件以上</span>

  </div>

  <img src="/map.jpg" alt="日本地図" usemap="#japan_map" style="max-width:100%; height:auto; display:block;">

  <map name="japan_map">
    <?php foreach ($areas as [$code, $name, $coords, $points]): ?>
      <area
        shape="poly"
        coords="<?= h($coords) ?>"
        href="/prefecture.php?code=<?= (int)$code ?>"
        alt="<?= h($name) ?>"
      >
    <?php endforeach; ?>
  </map>


  <svg class="dm-heat-overlay" viewBox="0 0 894 894" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
    <?php foreach ($areas as [$code, $name, $coords, $points]): ?>
      <?php $cnt = $counts[(int)$code] ?? 0; ?>
      <polygon
        points="<?= h($points) ?>"
        fill="<?= h(heat_color((int)$cnt)) ?>"
        stroke="rgba(0,0,0,0.20)"
        stroke-width="1"
      />
    <?php endforeach; ?>
  </svg>
</div>

<script>
(() => {
  const wrap = document.getElementById("dmMapWrap");
  const btn  = document.getElementById("dmHeatBtn");
  const KEY  = "dm_heatmap_on";

  function setState(on) {
    if (on) {
      wrap.classList.add("heat-on");
      btn.textContent = "ON";
      btn.setAttribute("aria-pressed", "true");
      localStorage.setItem(KEY, "1");
    } else {
      wrap.classList.remove("heat-on");
      btn.textContent = "OFF";
      btn.setAttribute("aria-pressed", "false");
      localStorage.setItem(KEY, "0");
    }
  }

  // 初期状態（保存されていれば復元、なければOFF）
  const saved = localStorage.getItem(KEY);
  setState(saved === "1");

  btn.addEventListener("click", () => {
    const on = !wrap.classList.contains("heat-on");
    setState(on);
  });
})();
</script>
